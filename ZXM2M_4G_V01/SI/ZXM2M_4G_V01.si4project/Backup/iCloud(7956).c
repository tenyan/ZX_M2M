/*****************************************************************************
* @FileName: iCloud.c
* @Engineer: TenYan
* @version   V1.0
* @Date:     2020-1-6
* @brief
******************************************************************************/

/******************************************************************************
* Includes
******************************************************************************/
#include "config.h"

/******************************************************************************
* Typedef
******************************************************************************/


/******************************************************************************
* Define
******************************************************************************/

/******************************************************************************
* Macros
******************************************************************************/
#define ICLOUD_DELAY(ms)    msleep(ms)

/******************************************************************************
* Data Types and Globals
******************************************************************************/
uint8_t net_public_data_buffer[1460];


/******************************************************************************
 *
*******************************************************************************/



/******************************************************************************
 * iCloud模块任务函数
*******************************************************************************/
void AppThread_iCloud(void *argument)
{
  sysbus_msg_t msg;
  osStatus_t status;

  while (1)
  {
    status = SYSBUS_GetMbox(msg,10); // 等待消息(超时10ms)
    if (status == osOK) //对接收到的消息数据进行处理
    {
      SysBus_ProcessMsg(&msg);
    }
    HJEP_ProduceSendData();
    //GBEP_SendNetData();
    M2M_ProduceSendMsg(&m2m_context);
  }
}

/*************************************************************************
 *
*************************************************************************/
void iCloud_ServiceInit(void)
{
  if(mqid_SysBusMbox==NULL)
  {
    mqid_SysBusMbox = osMessageQueueNew(SIZE_OF_SYSTEM_BUS_QUEUE, sizeof(sysbus_msg_t), NULL); // 创建消息邮箱
  }
  
  Parm_ReadM2mAssetData();
  Parm_ReadLvcInfo();
  //SysCounterInit();
  COLT_ReadInternalWdtState();
  M2M_Initialize();
}

/*************************************************************************
 *
*************************************************************************/
void iCloud_ServiceStart(void)
{
  tid_iCloud = osThreadNew(AppThread_iCloud, NULL, &AppThreadAttr_iCloud);
}

